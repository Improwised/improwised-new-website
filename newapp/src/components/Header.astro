---
import { SITE_TITLE, BASE_URL } from "../consts";
import { Image } from "astro:assets";
import Logo from "$lib/images/logo.png";
import { Button } from "$lib/components/ui/button";
import Dropdown from "$lib/components/common/Dropdown.svelte";
import ToggleTheme from "$lib/components/common/ToggleTheme.svelte"
import { getCollection } from "astro:content";
import Dialog from "$lib/components/common/Dialog.svelte"
import SearchBar from "astro-pagefind/components/Search";
const services = (Object.values(await getCollection('services')).sort((a, b) => a.data.order - b.data.order)).filter(service => service.id !== "technology-consulting" && service.id !== "product-modernization" &&  service.id !== "cloud-infrastructure-services")

import Sidebar from "./Sidebar.astro";
const currentUrl = Astro.url.pathname.split("/")
import { Menu, X } from "lucide-svelte";

let blogDetail = {};
const url: string[] = Astro.url.pathname.split("/");
if (url.includes("blog") && url.at(-2) !== "blog") {
  blogDetail = await getCollection("blogs", (blog) => blog.id == url.at(-2));
}

---

<header
  id="up"
  class="fixed top-0 left-0 right-0 border-b border-transparent transition-all z-50"
>
  <div class="relative">
    <div id="desktop-header"
    class="relative container z-50 flex flex-col items-center justify-between lg:flex-row px-4 py-3"
  >
    <div id="impro-logo" class="z-50 flex w-full items-center justify-between lg:w-auto">
      <a href={BASE_URL + "/"} class="flex items-center transition" aria-label="Improwised Technologies homepage - cloud infrastructure and platform engineering services">
        <Image
          src={Logo}
          class="w-[150px] lg:w-[200px]"
          alt={SITE_TITLE}
          loading="eager"
          decoding="async"
        />
      </a>

      <div class="flex gap-4 lg:hidden items-center">
        <ToggleTheme client:only/>
        <button id="impronav-menu"  aria-label="Toggle Menu" class="hover:cursor-pointer h-6 w-6">
          <Menu class="h-6 w-6" id="menuIconMenu" />
        </button>
      </div>
    </div>

    <!-- scrollspay -->
    { Object.keys(blogDetail).length > 0 &&
      ((currentUrl.includes("blog") && currentUrl.indexOf("blog") < currentUrl.length-1) || (currentUrl.includes("privacy-policy")) || (currentUrl.includes("terms-of-use"))) && <Sidebar insideMdx="outside" />
    }

    <nav
      class="impronav-items mt-2 hidden w-full lg:mt-0 lg:flex lg:w-auto lg:bg-transparent bg-white"
    >
    <ul class="flex flex-col lg:flex-row lg:gap-3">
      <li class="content-center px-1">
        <a
          aria-label="Improwised Technologies homepage - cloud infrastructure and platform engineering services"
          href={`${BASE_URL}/`}
          class={`hover:text-blue-hover py-2 transition lg:px-3 small-text ${currentUrl.at(1) == "" ? "text-blue-hover" : "text-first-color" }`}
          >Home</a
        >
      </li>
      <li class="content-center px-1">
        <a
          href={`${BASE_URL}/about-improwised/`}
          aria-label="Learn more about our company on the About Us page"
          class={`hover:text-blue-hover py-2 transition lg:px-3 small-text ${currentUrl.includes("about-improwised") ? "text-blue-hover" : "text-first-color"}`}
          >About Us</a
        >
      </li>
      <li class="content-center px-1">
        <span class="hover:text-blue-hover py-2 mb-5 transition lg:px-3">
          <Dropdown client:load services={services} baseUrl={BASE_URL} currentUrl={currentUrl} />
        </span>
      </li>
      <li class="content-center px-1">
        <a
          href={`${BASE_URL}/case-studies/`}
          aria-label="Learn more about our Case Studies"
          class={`hover:text-blue-hover py-2 transition lg:px-3 small-text ${currentUrl.includes("case-studies") ? "text-blue-hover" : "text-first-color"}`}
          >Case Studies</a
        >
      </li>
      <li class="content-center px-1">
        <a
          href={`${BASE_URL}/careers/`}
          aria-label="Our Career Page"
          class={`hover:text-blue-hover py-2 transition lg:px-3 small-text ${currentUrl.includes("careers") ? "text-blue-hover" : "text-first-color"}`}
          >Careers</a
        >
      </li>
      <li class="content-center px-1">
        <a
          href={`${BASE_URL}/blog/`}
          aria-label="Our Blog Page"
          class={`hover:text-blue-hover py-2 transition lg:px-3 small-text ${currentUrl.includes("blog") ? "text-blue-hover" : "text-first-color"}`}
          >Blog</a
        >
      </li>
    </ul>

      <div class="mt-3 flex items-center gap-4 lg:hidden">
        <Button href={`${BASE_URL}/contact/`} class="bg-black" aria-label="Go to Contact Us page">
          Contact Us
        </Button>
      </div>
    </nav>
    <div>
      <div class="hidden items-center gap-4 lg:flex">
        <ToggleTheme client:only />
        <Dialog client:only>
          <SearchBar id="search1" className="pagefind-ui search-pagefind" uiOptions={{ showImages: false }} />
        </Dialog>
        <Button href={`${BASE_URL}/contact/`} class="button-bg" aria-label="Go to Contact Us page">
          Contact Us
        </Button>
      </div>
    </div>
  </div>

  <nav id="mobile-nav"
      class="bg-effect -z-40 pt-3 flex impronav-shadow lg:hidden impronav-toggle absolute top-0 px-4 pb-4 -translate-y-[392px] transition-all duration-500 flex-col w-full bg-white"
    >
      <div class="z-50 flex w-full items-center justify-between lg:w-auto">
        <a href={BASE_URL + "/"} class="flex items-center transition">
          <Image
            src={Logo}
            class="w-[150px] lg:w-[200px]"
            alt={SITE_TITLE}
            loading="eager"
            decoding="async"
          /></a
        >

        <div class="block lg:hidden h-6 w-6">
          <button id="impronav-close-menu" class="hidden hover:cursor-pointer" aria-label="Toggle Menu">
            <X class="h-6 w-6" id="menuIconMenu" />
          </button>
        </div>
      </div>
      <ul class="flex flex-col lg:gap-3">
        <li class={`hover:text-blue-hover py-2 transition lg:px-3 ${currentUrl.at(1) == "" ? "text-blue-hover" : "text-first-color" }`}>
          <a
            href={`${BASE_URL}/`}
            aria-label="Improwised Technologies homepage - cloud infrastructure and platform engineering services"
              >Home</a
          >
        </li>
        <li class={`hover:text-blue-hover py-2 transition lg:px-3 ${currentUrl.includes("about-improwised") ? "text-blue-hover" : "text-first-color"}`}>
          <a
            href={`${BASE_URL}/about-improwised`}
            aria-label="Learn more about our company on the About Us page"
            >About Us</a
          >
        </li>
        <li class={`py-2 transition lg:px-3 ${currentUrl.includes("services") ? "text-blue-hover" : "text-first-color"}`}>
          <Dropdown client:load services={services} baseUrl={BASE_URL} />
        </li>
        <li class={`hover:text-blue-hover py-2 transition lg:px-3 ${currentUrl.includes("case-studies") ? "text-blue-hover" : "text-first-color"}`}>
          <a
            href={`${BASE_URL}/case-studies`}
            aria-label="Learn more about our Case Studies"
            >Case Studies</a
          >
        </li>
        <li class={`hover:text-blue-hover py-2 transition lg:px-3 ${currentUrl.includes("careers") ? "text-blue-hover" : "text-first-color"}`}>
          <a
            href={`${BASE_URL}/careers`}
            aria-label="Our Career Page"
            >Careers</a
          >
        </li>
        <li class={`hover:text-blue-hover py-2 transition lg:px-3 ${currentUrl.includes("blog") ? "text-blue-hover" : "text-first-color"}`}>
          <a
            href={`${BASE_URL}/blog`}
            aria-label="Our Blog Page"
            >Blog</a
          >
        </li>
      </ul>
      <div class="mt-3 flex items-center gap-4 lg:hidden">
        <Button href=`${BASE_URL}/contact` class="button-bg" aria-label="Go to Contact Us page">
          Contact Us
        </Button>
      </div>
  </nav>

  </div>
</header>

<style>
  @reference 'tailwindcss';

  .impronav-sticky-header {
    background: transparent;
    width: 100%;
    /* z-index: 50; */
    transition:
      background 0.3s ease-in-out,
      backdrop-filter 0.3s ease-in-out,
      box-shadow 0.3s ease-in-out;
  }
  .scrolled {
    /* background: rgba(255, 255, 255, 0.3); */
    /* background: rgba(245,245,245, 0.1); */
    background: var(--navbar-bg);
    backdrop-filter: blur(16px);
  }

  .bg-effect {
    /* background:  rgba(245,245,245, 0.1); */
    background: var(--navbar-bg);
    backdrop-filter: blur(16px);
    box-shadow:
      0 4px 6px -1px rgb(0 0 0 / 0.1),
      0 2px 4px -2px rgb(0 0 0 / 0.1);
  }

  :global(.search-pagefind .pagefind-ui__search-input) {
    background-color: transparent;
    border: 2px solid var(--card-border);
    color: var(--text-first-color);
    transition: all 0.3s ease-in-out;
  }

  :global(.search-pagefind .pagefind-ui__search-input::placeholder) {
    color: var(--text-second-color);
    opacity: 0.6;
  }

  :global(.search-pagefind .pagefind-ui__search-input:focus) {
    border-color: var(--hover-blue);
    outline: none;
    box-shadow: 0 0 0 4px rgba(26, 184, 224, 0.15);
    background-color: var(--card-bg);
  }

  :global(.search-pagefind .pagefind-ui__search-clear) {
    background-color: transparent ;
    color: var(--text-second-color) ;
  }

  :global(.search-pagefind .pagefind-ui__search-clear:hover) {
    color: var(--hover-blue);
  }

  :global(.search-pagefind .pagefind-ui__result:hover) {
    background-color: var(--navbar-bg);
  }

  :global(.search-pagefind .pagefind-ui__result-link) {
    color: var(--text-first-color) !important;
    text-decoration: none;
  }

  :global(.search-pagefind .pagefind-ui__result-link:hover) {
    color: var(--hover-blue) !important;
  }

  :global(.search-pagefind .pagefind-ui__result-title) {
    color: var(--text-first-color) !important;
    font-weight: 600;
    font-size: 17px;
    margin-bottom: 6px;
  }
  
  :global(.search-pagefind .pagefind-ui__result-excerpt) {
    color: var(--text-second-color) !important;
    line-height: 1.6;
  }

  :global(.search-pagefind .pagefind-ui__result-tag) {
    background-color: var(--navbar-bg) !important;
    color: var(--text-first-color) !important;
    border: 1px solid var(--card-border);
  }

  :global(.search-pagefind .pagefind-ui__message) {
    color: var(--text-second-color) !important;
    padding: 20px;
    text-align: center;
    font-size: 15px;
  }

  :global(.search-pagefind .pagefind-ui__results-area) {
    margin-top: 20px;
  }

  :global(.search-pagefind .pagefind-ui__button) {
    background-color: transparent !important;
    color: var(--hover-blue) !important;
    border: 2px solid var(--hover-blue) !important;
    border-radius: 8px;
    padding: 10px 20px;
    font-weight: 500;
    transition: all 0.2s ease-in-out;
    cursor: pointer;
  }

  :global(.search-pagefind .pagefind-ui__button:hover) {
    background-color: var(--hover-blue) !important;
    color: var(--primary-white) !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(26, 184, 224, 0.3);
  }

  :global(.search-pagefind mark) {
    background-color: rgba(26, 184, 224, 0.25) !important;
    color: var(--hover-blue) !important;
    border-radius: 4px;
    padding: 2px 4px;
    font-weight: 600;
  }

  :global(.search-pagefind .pagefind-ui__drawer) {
    background-color: transparent !important;
  }

  :global(.search-dialog-content *::-webkit-scrollbar) {
    width: 8px;
  }

  :global(.search-dialog-content *::-webkit-scrollbar-track) {
    background: transparent;
  }

  :global(.search-dialog-content *::-webkit-scrollbar-thumb) {
    background-color: var(--card-border);
    border-radius: 4px;
  }

  :global(.search-dialog-content *::-webkit-scrollbar-thumb:hover) {
    background-color: var(--hover-blue);
  } 
</style>

<script>
  import { PagefindUI } from "@pagefind/default-ui";

  function tryInitSearch() {
    const searchEl = document.querySelector('#search1.pagefind-init');
    if (searchEl) {
      const bundlePath = searchEl.getAttribute("data-bundle-path");
      const opts = JSON.parse(searchEl.getAttribute("data-ui-options") ?? "{}");
      new PagefindUI({
        ...opts,
        element: "#search1",
        bundlePath,
      });
      searchEl.classList.remove("pagefind-init");
      return true;
    }
    return false;
  }

  function initSearchInDialog() {
    // Try immediate initialization
    tryInitSearch();

    // Watch for dialog opening and search element being added
    const observer = new MutationObserver((mutations) => {
      for (const mutation of mutations) {
        for (const node of mutation.addedNodes) {
          if (node instanceof HTMLElement) {
            const searchEl = node.querySelector?.('#search1.pagefind-init') || 
                            (node.id === 'search1' && node.classList.contains('pagefind-init') ? node : null);
            
            if (searchEl) {
              setTimeout(() => tryInitSearch(), 100);
              return;
            }
          }
        }
      }
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true,
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initSearchInDialog);
  } else {
    initSearchInDialog();
  }
</script>
